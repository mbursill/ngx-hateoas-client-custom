import { ResourceCollection } from './resource-collection';
import { throwError as observableThrowError } from 'rxjs';
import { getPagedResourceCollectionHttpService } from '../../service/internal/paged-resource-collection-http.service';
import { StageLogger } from '../../logger/stage-logger';
import { Stage } from '../../logger/stage.enum';
import { tap } from 'rxjs/operators';
import { ValidationUtils } from '../../util/validation.utils';
import { isEmpty, isNumber, result } from 'lodash-es';
/**
 * Collection of resources with pagination.
 */
export class PagedResourceCollection extends ResourceCollection {
    /**
     * Create a new paged resource collection from resource collection with the page data.
     *
     * @param resourceCollection collection that will be paged
     * @param pageData contains data about characteristics of the page.
     */
    constructor(resourceCollection, pageData) {
        super(resourceCollection);
        this.totalElements = result(pageData, 'page.totalElements', 0);
        this.totalPages = result(pageData, 'page.totalPages', 1);
        this.pageSize = result(pageData, 'page.size', 20);
        this.pageNumber = result(pageData, 'page.number', 0);
        this.selfLink = result(pageData, '_links.self', null);
        this.nextLink = result(pageData, '_links.next', null);
        this.prevLink = result(pageData, '_links.prev', null);
        this.firstLink = result(pageData, '_links.first', null);
        this.lastLink = result(pageData, '_links.last', null);
    }
    hasFirst() {
        return !!this.firstLink && !!this.firstLink.href;
    }
    hasLast() {
        return !!this.lastLink && !!this.lastLink.href;
    }
    hasNext() {
        return !!this.nextLink && !!this.nextLink.href;
    }
    hasPrev() {
        return !!this.prevLink && !!this.prevLink.href;
    }
    first(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_FIRST_PAGE');
        if (!this.hasFirst()) {
            const errMsg = 'Page has not first url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.firstLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_FIRST_PAGE', { result: 'get first page was performed successful' });
        }));
    }
    last(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_LAST_PAGE');
        if (!this.hasLast()) {
            const errMsg = 'Page has not last url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.lastLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_LAST_PAGE', { result: 'get last page was performed successful' });
        }));
    }
    next(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_NEXT_PAGE');
        if (!this.hasNext()) {
            const errMsg = 'Page has not next url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.nextLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_NEXT_PAGE', { result: 'get next page was performed successful' });
        }));
    }
    prev(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_PREV_PAGE');
        if (!this.hasPrev()) {
            const errMsg = 'Page has not prev url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.prevLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_PREV_PAGE', { result: 'get prev page was performed successful' });
        }));
    }
    page(pageNumber, options) {
        return this.customPage({ pageParams: { page: pageNumber } }, options);
    }
    size(size, options) {
        return this.customPage({ pageParams: { page: 0, size } }, options);
    }
    sortElements(sortParam, options) {
        return this.customPage({ sort: sortParam }, options);
    }
    /**
     * Perform query with custom page data.
     * That allows you change page size, current page or sort options.
     *
     * @param params contains data about new characteristics of the page.
     * @param options (optional) additional options that will be applied to the request
     * @throws error when required params are not valid or when passed inconsistent data
     */
    customPage(params, options) {
        StageLogger.resourceBeginLog(this.resources[0], 'CustomPage', { pageParam: params.pageParams });
        if (!params.pageParams || isEmpty(params.pageParams)) {
            params.pageParams = {};
            params.pageParams.page = this.pageNumber;
            params.pageParams.size = this.pageSize;
        }
        if (!isNumber(params.pageParams.page) || params.pageParams.page < 0) {
            params.pageParams.page = this.pageNumber;
            StageLogger.stageLog(Stage.PREPARE_PARAMS, {
                message: 'Page number is not passed will be used current value',
                currentPageNumber: this.pageNumber
            });
        }
        if (!isNumber(params.pageParams.size) || params.pageParams.size < 0) {
            params.pageParams.size = this.pageSize;
            StageLogger.stageLog(Stage.PREPARE_PARAMS, {
                message: 'Page size is not passed will be used current value',
                currentPageSize: this.pageSize
            });
        }
        const maxPageNumber = (this.totalElements / params.pageParams.size);
        if (params.pageParams.page > maxPageNumber) {
            const errMsg = `Error page number. Max page number is ${parseInt(maxPageNumber + '', 10)}`;
            StageLogger.stageErrorLog(Stage.PREPARE_PARAMS, { error: errMsg });
            return observableThrowError(errMsg);
        }
        const requestUrl = new URL(this.selfLink.href);
        requestUrl.searchParams.delete('page');
        requestUrl.searchParams.delete('size');
        requestUrl.searchParams.delete('sort');
        return doRequest(requestUrl.href, options?.useCache, params).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'CustomPage', { result: 'custom page was performed successful' });
        }));
    }
}
function doRequest(url, useCache = true, params) {
    ValidationUtils.validateInputParams({ url });
    return getPagedResourceCollectionHttpService()
        .get(url, { ...params, useCache });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZWQtcmVzb3VyY2UtY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oYXRlb2FzLWNsaWVudC9zcmMvbGliL21vZGVsL3Jlc291cmNlL3BhZ2VkLXJlc291cmNlLWNvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFM0QsT0FBTyxFQUFjLFVBQVUsSUFBSSxvQkFBb0IsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RSxPQUFPLEVBQUUscUNBQXFDLEVBQUUsTUFBTSwrREFBK0QsQ0FBQztBQUV0SCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXREOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUFnRCxTQUFRLGtCQUFxQjtJQWF4Rjs7Ozs7T0FLRztJQUNILFlBQVksa0JBQXlDLEVBQUUsUUFBbUI7UUFDeEUsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9ELElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFF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QUFDO0lBRTNDLE9BQU8scUNBQXFDLEVBQUU7U0FDM0MsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFDLEdBQUcsTUFBTSxFQUFFLFFBQVEsRUFBQyxDQUEyQyxDQUFDO0FBQy9FLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNvdXJjZUNvbGxlY3Rpb24gfSBmcm9tICcuL3Jlc291cmNlLWNvbGxlY3Rpb24nO1xyXG5pbXBvcnQgeyBCYXNlUmVzb3VyY2UgfSBmcm9tICcuL2Jhc2UtcmVzb3VyY2UnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIGFzIG9ic2VydmFibGVUaHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGdldFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uSHR0cFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL2ludGVybmFsL3BhZ2VkLXJlc291cmNlLWNvbGxlY3Rpb24taHR0cC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGlua0RhdGEsIFBhZ2VEYXRhLCBTb3J0LCBTb3J0ZWRQYWdlUGFyYW0gfSBmcm9tICcuLi9kZWNsYXJhdGlvbnMnO1xyXG5pbXBvcnQgeyBTdGFnZUxvZ2dlciB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS1sb2dnZXInO1xyXG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb24udXRpbHMnO1xyXG5pbXBvcnQgeyBpc0VtcHR5LCBpc051bWJlciwgcmVzdWx0IH0gZnJvbSAnbG9kYXNoLWVzJztcclxuXHJcbi8qKlxyXG4gKiBDb2xsZWN0aW9uIG9mIHJlc291cmNlcyB3aXRoIHBhZ2luYXRpb24uXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgUGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4gZXh0ZW5kcyBSZXNvdXJjZUNvbGxlY3Rpb248VD4ge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHNlbGZMaW5rOiBMaW5rRGF0YTtcclxuICBwcml2YXRlIHJlYWRvbmx5IG5leHRMaW5rOiBMaW5rRGF0YTtcclxuICBwcml2YXRlIHJlYWRvbmx5IHByZXZMaW5rOiBMaW5rRGF0YTtcclxuICBwcml2YXRlIHJlYWRvbmx5IGZpcnN0TGluazogTGlua0RhdGE7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsYXN0TGluazogTGlua0RhdGE7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSB0b3RhbEVsZW1lbnRzOiBudW1iZXI7XHJcbiAgcHVibGljIHJlYWRvbmx5IHRvdGFsUGFnZXM6IG51bWJlcjtcclxuICBwdWJsaWMgcmVhZG9ubHkgcGFnZU51bWJlcjogbnVtYmVyO1xyXG4gIHB1YmxpYyByZWFkb25seSBwYWdlU2l6ZTogbnVtYmVyO1xyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGUgYSBuZXcgcGFnZWQgcmVzb3VyY2UgY29sbGVjdGlvbiBmcm9tIHJlc291cmNlIGNvbGxlY3Rpb24gd2l0aCB0aGUgcGFnZSBkYXRhLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHJlc291cmNlQ29sbGVjdGlvbiBjb2xsZWN0aW9uIHRoYXQgd2lsbCBiZSBwYWdlZFxyXG4gICAqIEBwYXJhbSBwYWdlRGF0YSBjb250YWlucyBkYXRhIGFib3V0IGNoYXJhY3RlcmlzdGljcyBvZiB0aGUgcGFnZS5cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihyZXNvdXJjZUNvbGxlY3Rpb246IFJlc291cmNlQ29sbGVjdGlvbjxUPiwgcGFnZURhdGE/OiBQYWdlRGF0YSkge1xyXG4gICAgc3VwZXIocmVzb3VyY2VDb2xsZWN0aW9uKTtcclxuICAgIHRoaXMudG90YWxFbGVtZW50cyA9IHJlc3VsdChwYWdlRGF0YSwgJ3BhZ2UudG90YWxFbGVtZW50cycsIDApO1xyXG4gICAgdGhpcy50b3RhbFBhZ2VzID0gcmVzdWx0KHBhZ2VEYXRhLCAncGFnZS50b3RhbFBhZ2VzJywgMSk7XHJcbiAgICB0aGlzLnBhZ2VTaXplID0gcmVzdWx0KHBhZ2VEYXRhLCAncGFnZS5zaXplJywgMjApO1xyXG4gICAgdGhpcy5wYWdlTnVtYmVyID0gcmVzdWx0KHBhZ2VEYXRhLCAncGFnZS5udW1iZXInLCAwKTtcclxuXHJcbiAgICB0aGlzLnNlbGZMaW5rID0gcmVzdWx0KHBhZ2VEYXRhLCAnX2xpbmtzLnNlbGYnLCBudWxsKTtcclxuICAgIHRoaXMubmV4dExpbmsgPSByZXN1bHQocGFnZURhdGEsICdfbGlua3MubmV4dCcsIG51bGwpO1xyXG4gICAgdGhpcy5wcmV2TGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5wcmV2JywgbnVsbCk7XHJcbiAgICB0aGlzLmZpcnN0TGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5maXJzdCcsIG51bGwpO1xyXG4gICAgdGhpcy5sYXN0TGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5sYXN0JywgbnVsbCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzRmlyc3QoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gISF0aGlzLmZpcnN0TGluayAmJiAhIXRoaXMuZmlyc3RMaW5rLmhyZWY7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzTGFzdCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIXRoaXMubGFzdExpbmsgJiYgISF0aGlzLmxhc3RMaW5rLmhyZWY7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzTmV4dCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIXRoaXMubmV4dExpbmsgJiYgISF0aGlzLm5leHRMaW5rLmhyZWY7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzUHJldigpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIXRoaXMucHJldkxpbmsgJiYgISF0aGlzLnByZXZMaW5rLmhyZWY7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZmlyc3Qob3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcclxuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcy5yZXNvdXJjZXNbMF0sICdHRVRfRklSU1RfUEFHRScpO1xyXG4gICAgaWYgKCF0aGlzLmhhc0ZpcnN0KCkpIHtcclxuICAgICAgY29uc3QgZXJyTXNnID0gJ1BhZ2UgaGFzIG5vdCBmaXJzdCB1cmwnO1xyXG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7ZXJyb3I6IGVyck1zZ30pO1xyXG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZVRocm93RXJyb3IobmV3IEVycm9yKGVyck1zZykpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRvUmVxdWVzdDxUPih0aGlzLmZpcnN0TGluay5ocmVmLCBvcHRpb25zPy51c2VDYWNoZSkucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUVuZExvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9GSVJTVF9QQUdFJywge3Jlc3VsdDogJ2dldCBmaXJzdCBwYWdlIHdhcyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bCd9KTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbGFzdChvcHRpb25zPzogeyB1c2VDYWNoZTogdHJ1ZSB9KTogT2JzZXJ2YWJsZTxQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUPj4ge1xyXG4gICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VCZWdpbkxvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9MQVNUX1BBR0UnKTtcclxuICAgIGlmICghdGhpcy5oYXNMYXN0KCkpIHtcclxuICAgICAgY29uc3QgZXJyTXNnID0gJ1BhZ2UgaGFzIG5vdCBsYXN0IHVybCc7XHJcbiAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlRXJyb3JMb2coU3RhZ2UuUFJFUEFSRV9VUkwsIHtlcnJvcjogZXJyTXNnfSk7XHJcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlVGhyb3dFcnJvcihuZXcgRXJyb3IoZXJyTXNnKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZG9SZXF1ZXN0PFQ+KHRoaXMubGFzdExpbmsuaHJlZiwgb3B0aW9ucz8udXNlQ2FjaGUpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcy5yZXNvdXJjZXNbMF0sICdHRVRfTEFTVF9QQUdFJywge3Jlc3VsdDogJ2dldCBsYXN0IHBhZ2Ugd2FzIHBlcmZvcm1lZCBzdWNjZXNzZnVsJ30pO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZXh0KG9wdGlvbnM/OiB7IHVzZUNhY2hlOiB0cnVlIH0pOiBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+PiB7XHJcbiAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUJlZ2luTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnR0VUX05FWFRfUEFHRScpO1xyXG4gICAgaWYgKCF0aGlzLmhhc05leHQoKSkge1xyXG4gICAgICBjb25zdCBlcnJNc2cgPSAnUGFnZSBoYXMgbm90IG5leHQgdXJsJztcclxuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VFcnJvckxvZyhTdGFnZS5QUkVQQVJFX1VSTCwge2Vycm9yOiBlcnJNc2d9KTtcclxuICAgICAgcmV0dXJuIG9ic2VydmFibGVUaHJvd0Vycm9yKG5ldyBFcnJvcihlcnJNc2cpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBkb1JlcXVlc3Q8VD4odGhpcy5uZXh0TGluay5ocmVmLCBvcHRpb25zPy51c2VDYWNoZSkucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUVuZExvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9ORVhUX1BBR0UnLCB7cmVzdWx0OiAnZ2V0IG5leHQgcGFnZSB3YXMgcGVyZm9ybWVkIHN1Y2Nlc3NmdWwnfSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHByZXYob3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcclxuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcy5yZXNvdXJjZXNbMF0sICdHRVRfUFJFVl9QQUdFJyk7XHJcbiAgICBpZiAoIXRoaXMuaGFzUHJldigpKSB7XHJcbiAgICAgIGNvbnN0IGVyck1zZyA9ICdQYWdlIGhhcyBub3QgcHJldiB1cmwnO1xyXG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7ZXJyb3I6IGVyck1zZ30pO1xyXG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZVRocm93RXJyb3IobmV3IEVycm9yKGVyck1zZykpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRvUmVxdWVzdDxUPih0aGlzLnByZXZMaW5rLmhyZWYsIG9wdGlvbnM/LnVzZUNhY2hlKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlRW5kTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnR0VUX1BSRVZfUEFHRScsIHtyZXN1bHQ6ICdnZXQgcHJldiBwYWdlIHdhcyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bCd9KTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcGFnZShwYWdlTnVtYmVyOiBudW1iZXIsIG9wdGlvbnM/OiB7IHVzZUNhY2hlOiB0cnVlIH0pOiBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5jdXN0b21QYWdlKHtwYWdlUGFyYW1zOiB7cGFnZTogcGFnZU51bWJlcn19LCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaXplKHNpemU6IG51bWJlciwgb3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcclxuICAgIHJldHVybiB0aGlzLmN1c3RvbVBhZ2Uoe3BhZ2VQYXJhbXM6IHtwYWdlOiAwLCBzaXplfX0sIG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNvcnRFbGVtZW50cyhzb3J0UGFyYW06IFNvcnQsIG9wdGlvbnM/OiB7IHVzZUNhY2hlOiB0cnVlIH0pOiBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5jdXN0b21QYWdlKHtzb3J0OiBzb3J0UGFyYW19LCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBlcmZvcm0gcXVlcnkgd2l0aCBjdXN0b20gcGFnZSBkYXRhLlxyXG4gICAqIFRoYXQgYWxsb3dzIHlvdSBjaGFuZ2UgcGFnZSBzaXplLCBjdXJyZW50IHBhZ2Ugb3Igc29ydCBvcHRpb25zLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHBhcmFtcyBjb250YWlucyBkYXRhIGFib3V0IG5ldyBjaGFyYWN0ZXJpc3RpY3Mgb2YgdGhlIHBhZ2UuXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgKG9wdGlvbmFsKSBhZGRpdGlvbmFsIG9wdGlvbnMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcclxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWQgb3Igd2hlbiBwYXNzZWQgaW5jb25zaXN0ZW50IGRhdGFcclxuICAgKi9cclxuICBwdWJsaWMgY3VzdG9tUGFnZShwYXJhbXM6IFNvcnRlZFBhZ2VQYXJhbSwgb3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcclxuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcy5yZXNvdXJjZXNbMF0sICdDdXN0b21QYWdlJywge3BhZ2VQYXJhbTogcGFyYW1zLnBhZ2VQYXJhbXN9KTtcclxuXHJcbiAgICBpZiAoIXBhcmFtcy5wYWdlUGFyYW1zIHx8IGlzRW1wdHkocGFyYW1zLnBhZ2VQYXJhbXMpKSB7XHJcbiAgICAgIHBhcmFtcy5wYWdlUGFyYW1zID0ge307XHJcbiAgICAgIHBhcmFtcy5wYWdlUGFyYW1zLnBhZ2UgPSB0aGlzLnBhZ2VOdW1iZXI7XHJcbiAgICAgIHBhcmFtcy5wYWdlUGFyYW1zLnNpemUgPSB0aGlzLnBhZ2VTaXplO1xyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bWJlcihwYXJhbXMucGFnZVBhcmFtcy5wYWdlKSB8fCBwYXJhbXMucGFnZVBhcmFtcy5wYWdlIDwgMCkge1xyXG4gICAgICBwYXJhbXMucGFnZVBhcmFtcy5wYWdlID0gdGhpcy5wYWdlTnVtYmVyO1xyXG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUxvZyhTdGFnZS5QUkVQQVJFX1BBUkFNUywge1xyXG4gICAgICAgIG1lc3NhZ2U6ICdQYWdlIG51bWJlciBpcyBub3QgcGFzc2VkIHdpbGwgYmUgdXNlZCBjdXJyZW50IHZhbHVlJyxcclxuICAgICAgICBjdXJyZW50UGFnZU51bWJlcjogdGhpcy5wYWdlTnVtYmVyXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bWJlcihwYXJhbXMucGFnZVBhcmFtcy5zaXplKSB8fCBwYXJhbXMucGFnZVBhcmFtcy5zaXplIDwgMCkge1xyXG4gICAgICBwYXJhbXMucGFnZVBhcmFtcy5zaXplID0gdGhpcy5wYWdlU2l6ZTtcclxuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUFJFUEFSRV9QQVJBTVMsIHtcclxuICAgICAgICBtZXNzYWdlOiAnUGFnZSBzaXplIGlzIG5vdCBwYXNzZWQgd2lsbCBiZSB1c2VkIGN1cnJlbnQgdmFsdWUnLFxyXG4gICAgICAgIGN1cnJlbnRQYWdlU2l6ZTogdGhpcy5wYWdlU2l6ZVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtYXhQYWdlTnVtYmVyID0gKHRoaXMudG90YWxFbGVtZW50cyAvIHBhcmFtcy5wYWdlUGFyYW1zLnNpemUpO1xyXG4gICAgaWYgKHBhcmFtcy5wYWdlUGFyYW1zLnBhZ2UgPiBtYXhQYWdlTnVtYmVyKSB7XHJcbiAgICAgIGNvbnN0IGVyck1zZyA9IGBFcnJvciBwYWdlIG51bWJlci4gTWF4IHBhZ2UgbnVtYmVyIGlzICR7IHBhcnNlSW50KG1heFBhZ2VOdW1iZXIgKyAnJywgMTApIH1gO1xyXG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfUEFSQU1TLCB7ZXJyb3I6IGVyck1zZ30pO1xyXG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZVRocm93RXJyb3IoZXJyTXNnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXF1ZXN0VXJsID0gbmV3IFVSTCh0aGlzLnNlbGZMaW5rLmhyZWYpO1xyXG4gICAgcmVxdWVzdFVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdwYWdlJyk7XHJcbiAgICByZXF1ZXN0VXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3NpemUnKTtcclxuICAgIHJlcXVlc3RVcmwuc2VhcmNoUGFyYW1zLmRlbGV0ZSgnc29ydCcpO1xyXG4gICAgcmV0dXJuIGRvUmVxdWVzdDxUPihyZXF1ZXN0VXJsLmhyZWYsIG9wdGlvbnM/LnVzZUNhY2hlLCBwYXJhbXMpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcy5yZXNvdXJjZXNbMF0sICdDdXN0b21QYWdlJywge3Jlc3VsdDogJ2N1c3RvbSBwYWdlIHdhcyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bCd9KTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gZG9SZXF1ZXN0PFQgZXh0ZW5kcyBCYXNlUmVzb3VyY2U+KHVybDogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlQ2FjaGU6IGJvb2xlYW4gPSB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zPzogU29ydGVkUGFnZVBhcmFtKTogT2JzZXJ2YWJsZTxQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUPj4ge1xyXG4gIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHt1cmx9KTtcclxuXHJcbiAgcmV0dXJuIGdldFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uSHR0cFNlcnZpY2UoKVxyXG4gICAgLmdldCh1cmwsIHsuLi5wYXJhbXMsIHVzZUNhY2hlfSkgYXMgT2JzZXJ2YWJsZTxQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUPj47XHJcbn1cclxuIl19